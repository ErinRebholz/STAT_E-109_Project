---
title: "STAT_E-109_Project"
author: "Erin Rebholz, Nadia Zafar, Imran Naskani, Max Yanover"
output: html_document
date: "2023-03-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intitial package installation and data loading


```{r, packages}

#Install packages/libraries

library(dplyr)
library(ggplot2)

```


```{r, load}

#Load in csv data for project

data <- read.csv('SDOH_Quality.csv')

count_initial <- nrow(data)

str(data)

```
```{r}
#Filter to only acute care and critical access facilities

data <- data %>% filter(hospital_type == 'Acute Care Hospitals' |  hospital_type == 'Critical Access Hospitals') 

(count_cah_acutre <- nrow(data))

```
```{r}

# Drop facilities where zip code census demographic data is not available

data <- data %>% filter(median_age != "#N/A") 

(count_cah_acutre_zipNA <- nrow(data))

datana <- data %>% filter(!is.na(hosp_overall_rating ))
str(datana)
```



```{r}

#Switch to numeric variables fo censuse/SDOH measures

data$median_age <- as.numeric(data$median_age)
data$per_white_non_hisp <- as.numeric(data$per_white_non_hisp)
data$med_inc_15plus_12mo <- as.numeric(data$med_inc_15plus_12mo)
data$per_below_poverty <- as.numeric(data$per_below_poverty)
data$per_college_grad_deg_25_plus <- as.numeric(data$per_college_grad_deg_25_plus)
          
#Switch to numeric variables for quality measures
data$COMP_HIP_KNEE <- as.numeric(data$COMP_HIP_KNEE)
data$MORT_30_AMI <- as.numeric(data$MORT_30_AMI)
data$MORT_30_CABG <- as.numeric(data$MORT_30_CABG)
data$MORT_30_COPD <- as.numeric(data$MORT_30_COPD)
data$MORT_30_HF <- as.numeric(data$MORT_30_HF)
data$MORT_30_PN <- as.numeric(data$MORT_30_PN)
data$MORT_30_STK <- as.numeric(data$MORT_30_STK)
data$PSI_03 <- as.numeric(data$PSI_03)
data$PSI_04 <- as.numeric(data$PSI_04)
data$PSI_06 <- as.numeric(data$PSI_06)
data$PSI_08 <- as.numeric(data$PSI_08)
data$PSI_09 <- as.numeric(data$PSI_09)
data$PSI_10 <- as.numeric(data$PSI_10)
data$PSI_12 <- as.numeric(data$PSI_12)
data$PSI_11 <- as.numeric(data$PSI_11)
data$PSI_13 <- as.numeric(data$PSI_13)
data$PSI_11 <- as.numeric(data$PSI_11)
data$PSI_14 <- as.numeric(data$PSI_14)
data$PSI_15 <- as.numeric(data$PSI_15)
data$PSI_90 <- as.numeric(data$PSI_90)

#Switch chr variables to factor
data$city <- as.factor(data$city)
data$state <- as.factor(data$state)
data$hospital_type <- as.factor(data$hospital_type)
data$hospital_ownership <- as.factor(data$hospital_ownership)
data$census_region <- as.factor(data$census_region)
data$census_division <- as.factor(data$census_division)

#check to make sure all are now integers
str(data)

```

## Initial EDA - Overall Star Rating 

```{r}
#Histogram of Overall Hospital Star Rating

hist(data$hosp_overall_rating)


```

```{r}
#Figure 2
#Table of Overall Hospital Star Rating
(counts <- table(data$hosp_overall_rating))
```


```{r}
#Figure 2
#total number of rows in data
(nrows <- nrow(data))
```


```{r}

##SDOH Measures by Overall Hospital Rating

require(gridExtra)

plot1 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,13]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[13]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")


plot2 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,14]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[14]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")

plot3 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,15]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[15]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")


plot4 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,16]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[16]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")

plot5 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,17]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[17]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")

#Aggregate into a single graph
grid.arrange(plot1, plot2, plot3, plot4, plot5, ncol=3)


#Save

g <- arrangeGrob(plot1, plot2, plot3, plot4, plot5, ncol=3) #generates g
ggsave("SDOH.png", g, width = 20, height = 15, units = "cm")



```


```{r}
##------- Boxplot: Star Rating vs Social Indicators -------------

#------- Boxplot: Star Rating vs Median Age -------------
social.ind1 <- data %>% filter(!is.na(hosp_overall_rating)) %>% 
ggplot(aes(x = hosp_overall_rating, y = median_age, fill = as.factor(hosp_overall_rating))) + 
geom_boxplot(show.legend = F)  + facet_wrap(~hospital_type) + 
ylab('Median Age') 

#------- Boxplot: Star Rating vs Percentage White Population -------------
social.ind2 <- data %>% filter(!is.na(hosp_overall_rating)) %>% 
ggplot(aes(x = hosp_overall_rating, y = per_white_non_hisp, fill = as.factor(hosp_overall_rating))) + 
geom_boxplot(show.legend = F) + facet_wrap(~hospital_type) + 
ylab('White Pop %') 

#------- Boxplot: Star Rating vs Population Below Poverty -------------
social.ind3 <- data %>% filter(!is.na(hosp_overall_rating)) %>% 
ggplot(aes(x = hosp_overall_rating, y = per_below_poverty, fill = as.factor(hosp_overall_rating))) + 
geom_boxplot(show.legend = F)  + facet_wrap(~hospital_type) + 
ylab('Below Poverty %') 

#------- Boxplot: Star Rating vs per_college_grad_deg_25_plus -------------
social.ind4 <- data %>% filter(!is.na(hosp_overall_rating)) %>% 
ggplot(aes(x = hosp_overall_rating, y = per_college_grad_deg_25_plus, fill = as.factor(hosp_overall_rating))) + 
geom_boxplot(show.legend = F)  + facet_wrap(~hospital_type) + 
ylab('College Grad Degree %') 

#------- Boxplot: Star Rating vs med_inc_15plus_12mo -------------
social.ind5 <- data %>% filter(!is.na(hosp_overall_rating)) %>% 
ggplot(aes(x = hosp_overall_rating, y = med_inc_15plus_12mo, fill = as.factor(hosp_overall_rating))) + 
geom_boxplot(show.legend = F) + facet_wrap(~hospital_type) + 
ylab('Median Income $') 

#Five Graphs in One
grid.arrange(social.ind1, social.ind2, social.ind3, social.ind4, social.ind5, ncol=2)
grid.social.ind3 <- arrangeGrob(social.ind1, social.ind2,social.ind3, social.ind4, social.ind5, ncol=2) 

```




```{r, warning = FALSE}

##Mortality and Complication Measures by Overall Hospital Rating -- FINAL GROUP

require(gridExtra)

#21,22,23,36

plot1 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,21]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[21]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")


plot2 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,22]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[22]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")

plot3 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,23]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[23]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")


plot4 <- data %>% ggplot(aes(x=factor(as.factor(hosp_overall_rating)),y =data[,36]))+
  geom_boxplot(show.legend = F) +
  coord_flip() +
  ggtitle(colnames(data)[36]) + 
  ylab('Measure Value') + xlab("Hosp_Overall_Rating")

#Aggregate into a single graph
grid.arrange(plot1, plot2, plot3, plot4, ncol=2)


#Save
g <- arrangeGrob(plot1, plot2, plot3, plot4, ncol=2) #generates g
ggsave("Top4_Star.png", g, width = 25, height = 20, units = "cm")


```

#Correlation Plot

```{r}

#Correlation Plots for Key Numeric Variables

cor_data <- data %>% dplyr::select(13:17,21,22,23,36)

cor.plot(cor_data)


```





## Linear regression - FOur Different Measures - 1 for each!

```{r}
#Additional packages/libraries
#install.packages("Rtools")
#install.packages("psych")
#install.packages("PerformanceAnalytics")
#install.packages("olsrr")


library(psych)
library(PerformanceAnalytics)
library(MASS)
library(car)
library(olsrr)

```


```{r}
#Refresh on column names
colnames(data)

```

#Regression on the Composite measure for complications

```{r}

#Data cleaning -> Quality Measure 90 - > Composite Score for Other P Measures

mod_data <- data %>%  
   dplyr::select(4:5,8:17,36) %>% #Narrow to features to use in the model (plus one quality measure)
  filter(hosp_overall_rating != 'NA') %>% #remove NAs
  filter(PSI_90 != 'NA')  #Remove NAs from measure

# treat overall rating as a factor  
mod_data$hosp_overall_rating <- as.factor(mod_data$hosp_overall_rating)

table(mod_data$hospital_type)

```



```{r}
#Take a full model with all numeric terms

mod_mod <- lm(PSI_90~median_age+per_white_non_hisp+med_inc_15plus_12mo+
                per_below_poverty+per_college_grad_deg_25_plus+census_region,mod_data)

summary(mod_mod)

```


```{r}

#conduct a step AIC analysis to prioritize functions

new <- stepAIC(mod_mod)

```



```{r}

#Use model selected by stepAIC function
mod_modf <- lm(PSI_90~median_age+per_white_non_hisp+per_college_grad_deg_25_plus+census_region,mod_data)

summary(mod_modf)

```

```{r}
#VIF for PSI_90 
vif(mod_modf)

```


## Regression for Heart Failure

```{r}

#Data cleaning -> MORT_30_HF - > 30 Day Heart Failure Death Rate

hf_data <- data %>%  
  dplyr::select(4:5,8:17,22) %>% #Narrow to features to use in the model (plus one quality measure)
  filter(hosp_overall_rating != 'NA') %>% #remove NAs
  filter(MORT_30_HF != 'NA')  #Remove NAs from measure

# treat overall rating as a factor  
hf_data$hosp_overall_rating <- as.factor(hf_data$hosp_overall_rating)


```


## Regression for Pneumonia

```{r}

#Data cleaning -> MORT_30_PN - > 30 Day pneumonia death rate

pn_data <- data %>%  
  dplyr::select(4:5,8:17,23) %>% #Narrow to features to use in the model (plus one quality measure)
  filter(hosp_overall_rating != 'NA') %>% #remove NAs
  filter(MORT_30_PN != 'NA')  #Remove NAs from measure

# treat overall rating as a factor  
pn_data$hosp_overall_rating <- as.factor(pn_data$hosp_overall_rating)

```

## Regression for COPD

```{r}

#Data cleaning -> MORT_30_COPD - > 30 Day COPD death rate

copd_data <- data %>%  
  dplyr::select(4:5,8:17,21) %>% #Narrow to features to use in the model (plus one quality measure)
  filter(hosp_overall_rating != 'NA') %>% #remove NAs
  filter(MORT_30_COPD != 'NA')  #Remove NAs from measure

# treat overall rating as a factor  
copd_data$hosp_overall_rating <- as.factor(copd_data$hosp_overall_rating)


```



